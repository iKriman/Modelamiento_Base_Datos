DROP TABLE COMPANIA CASCADE CONSTRAINTS;
DROP TABLE DOMINIO CASCADE CONSTRAINTS;
DROP TABLE PERSONAL CASCADE CONSTRAINTS;
DROP TABLE IDIOMA CASCADE CONSTRAINTS;
DROP TABLE GENERO  CASCADE CONSTRAINTS;
DROP TABLE ESTADO_CIVIL CASCADE CONSTRAINTS;
DROP TABLE TITULACION CASCADE CONSTRAINTS;
DROP TABLE TITULO CASCADE CONSTRAINTS;
DROP TABLE COMUNA CASCADE CONSTRAINTS;
DROP TABLE REGION CASCADE CONSTRAINTS;

-- anadimos drop secuence
DROP SEQUENCE seq_comuna;
DROP SEQUENCE seq_compania;


CREATE TABLE COMPANIA 

    ( 
     id_empresa     NUMBER (2)  NOT NULL , 
     nombre_empresa VARCHAR2 (25)  NOT NULL , 
     calle          VARCHAR2 (50)  NOT NULL , 
     numeracion     NUMBER (5)  NOT NULL , 
     renta_promedio NUMBER (10)  NOT NULL , 
     pct_aumento    NUMBER (4,3) , 
     id_comuna      NUMBER (5)  NOT NULL , 
     id_region      NUMBER (2)  NOT NULL 
    ) 
;

ALTER TABLE COMPANIA 
    ADD CONSTRAINT COMPANIA_PK PRIMARY KEY ( id_empresa ) ;

ALTER TABLE COMPANIA 
    ADD CONSTRAINT COMPANIA_UN_NOMBRE UNIQUE ( nombre_empresa ) ;

CREATE TABLE COMUNA 
    ( 
     id_comuna     NUMBER (5)  NOT NULL , 
     comuna_nombre VARCHAR2 (25)  NOT NULL , 
     id_region     NUMBER (2)  NOT NULL 
    ) 
;

ALTER TABLE COMUNA 
    ADD CONSTRAINT COMUNA_PK PRIMARY KEY ( id_comuna, id_region ) ;

CREATE TABLE DOMINIO 
    ( 
     id_idioma   NUMBER (3)  NOT NULL , 
     rut_persona NUMBER (8)  NOT NULL , 
     nivel       VARCHAR2 (25)  NOT NULL 
    ) 
;

ALTER TABLE DOMINIO 
    ADD CONSTRAINT DOMINIO_PK PRIMARY KEY ( id_idioma, rut_persona ) ;

CREATE TABLE ESTADO_CIVIL 
    ( 
     id_estado_civil       VARCHAR2 (2)  NOT NULL , 
     descripcion_est_civil VARCHAR2 (25)  NOT NULL 
    ) 
;

ALTER TABLE ESTADO_CIVIL 
    ADD CONSTRAINT ESTADO_CIVIL_PK PRIMARY KEY ( id_estado_civil ) ;

CREATE TABLE GENERO 
    ( 
     id_genero          VARCHAR2 (3)  NOT NULL , 
     descripcion_genero VARCHAR2 (25)  NOT NULL 
    ) 
;

ALTER TABLE GENERO 
    ADD CONSTRAINT GENERO_PK PRIMARY KEY ( id_genero ) ;

CREATE TABLE IDIOMA 
    ( 
     id_idioma     NUMBER (3) GENERATED BY DEFAULT ON NULL 
     AS IDENTITY (START WITH 25 INCREMENT BY 3), 
     nombre_idioma VARCHAR2 (30)  NOT NULL 
    ) 
;

ALTER TABLE IDIOMA 
    ADD CONSTRAINT IDIOMA_PK PRIMARY KEY ( id_idioma ) ;

CREATE TABLE PERSONAL 
    ( 
     rut_persona        NUMBER (8)  NOT NULL , 
     dv_persona         CHAR (1)  NOT NULL , 
     primer_nombre      VARCHAR2 (25)  NOT NULL , 
     segundo_nombre     VARCHAR2 (25) , 
     primer_apellido    VARCHAR2 (25)  NOT NULL , 
     segundo_apellido   VARCHAR2 (25)  NOT NULL , 
     fecha_contratacion DATE  NOT NULL , 
     fecha_nacimiento   DATE  NOT NULL , 
     email              VARCHAR2 (100) , 
     calle              VARCHAR2 (50)  NOT NULL , 
     numeracion         NUMBER (5)  NOT NULL , 
     sueldo             NUMBER (6)  DEFAULT 450000 NOT NULL , 
     id_estado_civil    VARCHAR2 (2)  NOT NULL , 
     id_comuna          NUMBER (5)  NOT NULL , 
     id_region          NUMBER (2)  NOT NULL , 
     id_empresa         NUMBER (2)  NOT NULL , 
     id_genero          VARCHAR2 (3)  NOT NULL 
    ) 
;

ALTER TABLE PERSONAL 
    ADD CONSTRAINT PERSONAL_PK PRIMARY KEY ( rut_persona ) ;

CREATE TABLE REGION 
    ( 
     id_region     NUMBER (2)  GENERATED BY DEFAULT ON NULL 
     AS IDENTITY (START WITH 7 INCREMENT BY 2), 
     nombre_region VARCHAR2 (25)  NOT NULL 
    ) 
;

ALTER TABLE REGION 
    ADD CONSTRAINT REGION_PK PRIMARY KEY ( id_region ) ;

CREATE TABLE TITULACION 
    ( 
     id_titulo        VARCHAR2 (3)  NOT NULL , 
     rut_persona      NUMBER (8)  NOT NULL , 
     fecha_titulacion DATE  NOT NULL 
    ) 
;

ALTER TABLE TITULACION 
    ADD CONSTRAINT TITULACION_PK PRIMARY KEY ( id_titulo, rut_persona ) ;

CREATE TABLE TITULO 
    ( 
     id_titulo          VARCHAR2 (3)  NOT NULL , 
     descripcion_titulo VARCHAR2 (60)  NOT NULL 
    ) 
;

ALTER TABLE TITULO 
    ADD CONSTRAINT TITULO_PK PRIMARY KEY ( id_titulo ) ;

ALTER TABLE COMPANIA 
    ADD CONSTRAINT COMPANIA_COMUNA_FK FOREIGN KEY 
    ( 
     id_comuna,
     id_region
    ) 
    REFERENCES COMUNA 
    ( 
     id_comuna,
     id_region
    ) 
;

ALTER TABLE COMUNA 
    ADD CONSTRAINT COMUNA_FK_REGION FOREIGN KEY 
    ( 
     id_region
    ) 
    REFERENCES REGION 
    ( 
     id_region
    ) 
;

ALTER TABLE DOMINIO 
    ADD CONSTRAINT DOMINIO_IDIOMA_FK FOREIGN KEY 
    ( 
     id_idioma
    ) 
    REFERENCES IDIOMA 
    ( 
     id_idioma
    ) 
;

ALTER TABLE DOMINIO 
    ADD CONSTRAINT DOMINIO_PERSONAL_FK FOREIGN KEY 
    ( 
     rut_persona
    ) 
    REFERENCES PERSONAL 
    ( 
     rut_persona
    ) 
;

ALTER TABLE PERSONAL 
    ADD CONSTRAINT PERSONAL_COMPANIA_FK FOREIGN KEY 
    ( 
     id_empresa
    ) 
    REFERENCES COMPANIA 
    ( 
     id_empresa
    ) 
;

ALTER TABLE PERSONAL 
    ADD CONSTRAINT PERSONAL_COMUNA_FK FOREIGN KEY 
    ( 
     id_comuna,
     id_region
    ) 
    REFERENCES COMUNA 
    ( 
     id_comuna,
     id_region
    ) 
;

ALTER TABLE PERSONAL 
    ADD CONSTRAINT PERSONAL_ESTADO_CIVIL_FK FOREIGN KEY 
    ( 
     id_estado_civil
    ) 
    REFERENCES ESTADO_CIVIL 
    ( 
     id_estado_civil
    ) 
;

ALTER TABLE PERSONAL 
    ADD CONSTRAINT PERSONAL_GENERO_FK FOREIGN KEY 
    ( 
     id_genero
    ) 
    REFERENCES GENERO 
    ( 
     id_genero
    ) 
;

ALTER TABLE TITULACION 
    ADD CONSTRAINT TITULACION_PERSONAL_FK FOREIGN KEY 
    ( 
     rut_persona
    ) 
    REFERENCES PERSONAL 
    ( 
     rut_persona
    ) 
;

ALTER TABLE TITULACION 
    ADD CONSTRAINT TITULACION_TITULO_FK FOREIGN KEY 
    ( 
     id_titulo
    ) 
    REFERENCES TITULO 
    ( 
     id_titulo
    ) 
;


-- creacion de la secuencia para COMUNA
CREATE SEQUENCE seq_comuna
START WITH 1101
INCREMENT BY 6
NOCACHE;
-- creacion de la secuencia para COMPANIA
CREATE SEQUENCE seq_compania
START WITH 10
INCREMENT BY 5
NOCACHE;

// hacemos que el email sea unico para cada persona
ALTER TABLE PERSONAL 
ADD CONSTRAINT uk_email_personal UNIQUE (email);

// agregamos el check de los digitos del rut
ALTER TABLE PERSONAL 
ADD CONSTRAINT chk_dv 
CHECK (dv_persona IN ('0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'K'));

-- poblamiento de las tablas --

-- tabla REGION
INSERT INTO REGION (id_region, nombre_region) VALUES (7, 'ARICA Y PARINACOTA');
INSERT INTO REGION (id_region, nombre_region) VALUES (9, 'METROPOLITANA');
INSERT INTO REGION (id_region, nombre_region) VALUES (11, 'LA ARAUCANIA');

-- tabla IDIOMA
INSERT INTO IDIOMA (id_idioma, nombre_idioma) VALUES (25, 'Ingles');
INSERT INTO IDIOMA (id_idioma, nombre_idioma) VALUES (28, 'Chino');
INSERT INTO IDIOMA (id_idioma, nombre_idioma) VALUES (31, 'Aleman');
INSERT INTO IDIOMA (id_idioma, nombre_idioma) VALUES (34, 'Espanol');
INSERT INTO IDIOMA (id_idioma, nombre_idioma) VALUES (37, 'Frances');

-- tabla COMUNA
INSERT INTO COMUNA (id_comuna, comuna_nombre, id_region) VALUES (seq_comuna.nextval, 'Arica', 7);
INSERT INTO COMUNA (id_comuna, comuna_nombre, id_region) VALUES (seq_comuna.nextval, 'Santiago', 9);
INSERT INTO COMUNA (id_comuna, comuna_nombre, id_region) VALUES (seq_comuna.nextval, 'Temuco', 11);

-- tabla COMPANIA
INSERT INTO COMPANIA (id_empresa, nombre_empresa, calle, numeracion, renta_promedio, pct_aumento, id_comuna, id_region) 
VALUES (seq_compania.nextval, 'CCyRojas', 'Amapolas', 506, 1857000, 0.500, 1101, 7);
INSERT INTO COMPANIA (id_empresa, nombre_empresa, calle, numeracion, renta_promedio, pct_aumento, id_comuna, id_region) 
VALUES (seq_compania.nextval, 'SenTiTy', 'Los Alamos', 3490, 897000, 0.025, 1101, 7);
INSERT INTO COMPANIA (id_empresa, nombre_empresa, calle, numeracion, renta_promedio, pct_aumento, id_comuna, id_region) 
VALUES (seq_compania.nextval, 'Praxia LTDA', 'Las Camelias', 11098, 2157000, 0.035, 1107, 9);
INSERT INTO COMPANIA (id_empresa, nombre_empresa, calle, numeracion, renta_promedio, pct_aumento, id_comuna, id_region) 
VALUES (seq_compania.nextval, 'TIC spa', 'FLORES S.A.', 4357, 857000, NULL, 1107, 9);
INSERT INTO COMPANIA (id_empresa, nombre_empresa, calle, numeracion, renta_promedio, pct_aumento, id_comuna, id_region) 
VALUES (seq_compania.nextval, 'SANTANA LTDA', 'AVDA VIC. MACKENA', 106, 757000, 0.015, 1101, 7);
INSERT INTO COMPANIA (id_empresa, nombre_empresa, calle, numeracion, renta_promedio, pct_aumento, id_comuna, id_region) 
VALUES (seq_compania.nextval, 'FLORES Y ASOCIADOS', 'PEDRO LATORRE', 557, 589000, 0.015, 1107, 9);
INSERT INTO COMPANIA (id_empresa, nombre_empresa, calle, numeracion, renta_promedio, pct_aumento, id_comuna, id_region) 
VALUES (seq_compania.nextval, 'J.A. HOFFMAN', 'LATINA D.32', 509, 1857000, 0.025, 1113, 11);
INSERT INTO COMPANIA (id_empresa, nombre_empresa, calle, numeracion, renta_promedio, pct_aumento, id_comuna, id_region) 
VALUES (seq_compania.nextval, 'CAGLIARI D.', 'ALAMEDA', 206, 1857000, NULL, 1107, 9);
INSERT INTO COMPANIA (id_empresa, nombre_empresa, calle, numeracion, renta_promedio, pct_aumento, id_comuna, id_region) 
VALUES (seq_compania.nextval, 'Rojas HNOS LTDA', 'SUCRE', 106, 957000, 0.005, 1113, 11);
INSERT INTO COMPANIA (id_empresa, nombre_empresa, calle, numeracion, renta_promedio, pct_aumento, id_comuna, id_region) 
VALUES (seq_compania.nextval, 'FRIENDS P. S.A', 'SUECIA', 506, 857000, 0.015, 1113, 11);


-- INFORME 1 
-- INFORMACION DE LAS EMPRESA

SELECT
    nombre_empresa AS "Nombre Empresa",
    calle || ' ' || numeracion AS "Direccion",
    renta_promedio AS "Renta Promedio",
    (renta_promedio * (1+ pct_aumento)) AS "Simulacion de Renta"
FROM
    compania
ORDER BY
    "Renta Promedio" DESC, "Nombre Empresa" ASC;

-- INFORME 2
-- SIMULACION 15%
SELECT
    id_empresa                                      AS "CODIGO",
    nombre_empresa                                  AS "Empresa",
    renta_promedio                                  AS "Prom Renta Actual",
    ( pct_aumento + 0.15 )                          AS "Pct Aumento en 15%",
    ( renta_promedio * ( 1 + pct_aumento + 0.15 ) ) AS "Renta Aumentada"
FROM
    compania
ORDER BY
    "Prom Renta Actual" ASC,
    "Empresa" DESC;
    



